<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" 
  content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <!-- i hope you have a great day! -->
  <title>كالكوليتر المثقال والعملة النقدية</title>
  <meta name="description" content="آلة حاسبة ثنائية-كالكوليتر لتحويل بين المثقال البهائي والعملات النقدية">
  
  <link rel="stylesheet" href="ar.css">
  <link 
    rel="stylesheet" 
    href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css"
  />
  <link rel="apple-touch-icon-precomposed" sizes="57x57" href="favicon/apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="favicon/apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="favicon/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="favicon/apple-touch-icon-144x144.png" />
  <link rel="apple-touch-icon-precomposed" sizes="60x60" href="favicon/apple-touch-icon-60x60.png" />
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="favicon/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon-precomposed" sizes="76x76" href="favicon/apple-touch-icon-76x76.png" />
  <link rel="apple-touch-icon-precomposed" sizes="152x152" href="favicon/apple-touch-icon-152x152.png" />
  <link rel="icon" type="image/png" href="favicon/favicon-196x196.png" sizes="196x196" />
  <link rel="icon" type="image/png" href="favicon/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/png" href="favicon/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="favicon/favicon-16x16.png" sizes="16x16" />
  <link rel="icon" type="image/png" href="favicon/favicon-128.png" sizes="128x128" />
  <meta name="application-name" content="&nbsp;"/>
  <meta name="msapplication-TileColor" content="#FFFFFF" />
  <meta name="msapplication-TileImage" content="favicon/mstile-144x144.png" />
  <meta name="msapplication-square70x70logo" content="favicon/mstile-70x70.png" />
  <meta name="msapplication-square150x150logo" content="favicon/mstile-150x150.png" />
  <meta name="msapplication-wide310x150logo" content="favicon/mstile-310x150.png" />
  <meta name="msapplication-square310x310logo" content="favicon/mstile-310x310.png" />
  
</head>

<body>
  <div class="background"></div>
  <div class="calculator">
    <p class="a">الله أبهی</p>
    <div class="h1title">
    <h1>
        عــــملة
    </h1>
        <p class="pt">⇄</p>  
        <h1 >
            مـثـقـال
    </h1>
    </div>
    <p class="b">تحويل من وإلى</p> 
    <div class="form-group">
      <label class="c" for="metalType">:الـمعـدن</label>
      <div class="radio-inputs">
        <label class="radio">
          <input type="radio" name="metalType" value="gold" checked>
          <span class="name">ذهـب</span>
        </label>
        <label class="radio">
          <input type="radio" name="metalType" value="silver">
          <span class="name">فـضة</span>
        </label>
      </div>
    </div>
    <div class="form-group">
      <label for="mithqals">:الـوزن بالـمـثـقـال</label>
      <input 
        type="text" 
        id="mithqals" 
        placeholder="أدخال كمية المثقال" 
        oninput="formatMithqals(this); calculateMoneyFromMithqals()"
      />
    </div>
    <div class="form-group">
      <label for="money">:المبلـغ</label>
      <input 
        type="text" 
        id="money" 
        placeholder="أدخال مبلغ العملة" 
        oninput="formatMoney(this); calculateMithqalsFromMoney()"
        />
    </div>
    <div class="form-group">
        <label for="currencySelect">:الـعـمـلة</label>
        <select id="currencySelect" placeholder="Select or type to search">
            <option value="USD">USD – دولار أمريكي</option>
            <option value="EUR">EUR – يورو</option>
            <option value="GBP">GBP – جنيه إسترليني</option>
            <option value="CAD">CAD – دولار كندي</option>
            <option value="CUSTOM">صرف العملة الانتقائي   – قم بتعيين معدل التحويل الخاص بك</option>
            <option value="SAR">SAR – ريال سعودي</option>
            <option value="QAR">QAR – ريال قطري</option>
            <option value="OMR">OMR – ريال عماني</option>
            <option value="IQD">IQD – دينار عراقي</option>
            <option value="EGP">EGP – جنيه مصري</option>
            <option value="JOD">JOD – دينار أردني</option>
            <option value="TND">TND – دينار تونسي</option>
            <option value="BHD">BHD – دينار بحريني</option>

        <option disabled="true" value="none">.---- ----.  .---- ----.  .---- ----.  .---- ----.  .---- ----.</option>
        <option value="IRR">IRR – ريال إيراني</option>
        <option value="ILS">ILS – شيكل إسرائيلي جديد</option>
        <option value="AFN">AFN – أفغاني</option>
        <option value="ARS">ARS – بيزو أرجنتيني</option>
        <option value="AUD">AUD – دولار أسترالي</option>
        <option value="AZN">AZN – مانات أذربيجاني</option>
        <option value="BDT">BDT – تاكا بنغلاديشي</option>
        <option value="BOL">BOL – بوليفيانو بوليفي</option>
        <option value="BRL">BRL – ريال برازيلي</option>
        <option value="CDF">CDF – فرنك كونغولي</option>
        <option value="CLP">CLP – بيزو تشيلي</option>
        <option value="CNY">CNY – يوان صيني</option>
        <option value="COP">COP – بيزو كولومبي</option>
        <option value="CZK">CZK – كرونة تشيكية</option>
        <option value="DKK">DKK – كرونة دنماركية</option>
        <option value="DZD">DZD – دينار جزائري</option>
        <option value="ETB">ETB – بير إثيوبي</option>
        <option value="FJD">FJD – دولار فيجي</option>
        <option value="GEL">GEL – لاري جورجي</option>
        <option value="HKD">HKD – دولار هونغ كونغ</option>
        <option value="HUF">HUF – فورنت هنغاري</option>
        <option value="IDR">IDR – روبية إندونيسية</option>
        <option value="ISK">ISK – كرونة آيسلندية</option>
        <option value="JPY">JPY – ين ياباني</option>
        <option value="KES">KES – شلن كيني</option>
        <option value="KWD">KWD – دينار كويتي</option>
        <option value="MAD">MAD – درهم مغربي</option>
        <option value="MXN">MXN – بيزو مكسيكي</option>
        <option value="MYR">MYR – رينغيت ماليزي</option>
        <option value="NAD">NAD – دولار ناميبي</option>
        <option value="NGN">NGN – نايرا نيجيري</option>
        <option value="NOK">NOK – كرونة نرويجية</option>
        <option value="NPR">NPR – روبية نيبالية</option>
        <option value="NZD">NZD – دولار نيوزيلندي</option>
        <option value="PGK">PGK – كينا بابوا غينيا الجديدة</option>
        <option value="PHP">PHP – بيزو فلبيني</option>
        <option value="PKR">PKR – روبية باكستانية</option>
        <option value="PLN">PLN – زلوتي بولندي</option>
        <option value="RUB">RUB – روبل روسي</option>
        <option value="SGD">SGD – دولار سنغافوري</option>
        <option value="THB">THB – بات تايلاندي</option>
        <option value="TMT">TMT – مانات تركماني</option>
        <option value="TRY">TRY – ليرة تركية</option>
        <option value="TZS">TZS – شلن تنزاني</option>
        <option value="UGX">UGX – شلن أوغندي</option>
        <option value="UAH">UAH – هريفنا أوكرانية</option>
        <option value="UZS">UZS – سوم أوزبكي</option>
        <option value="VND">VND – دونغ فيتنامي</option>
        <option value="VUV">VUV – فاتو فانواتي</option>
        <option value="ZAR">ZAR – راند جنوب أفريقي</option>
        <option value="ZMW">ZMW – كواشا زامبي</option>

      </select>
    </div>

    <!-- The custom rate container def=hidden -->
    <div class="form-group" id="customRateContainer">
      <label for="customRate">دولار واحـد = ؟</label>
      <input 
        type="text" 
        id="customRate" 
        placeholder="أدخال معدل التحويل"
        oninput="formatMoney(this); customRateChanged();"
      />
    </div>


    <div class="bottombox">

      <a href="fa.html" class="noteng"><i>فارسی</i></a>
      <a href="ar-about.html" class="noteng"><i>لمعرفة المزيد</i></a>
      <a href="index.html" class="aboutlink"><i>english</i></a>
      
    </div>

  </div>

  <script 
    src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js">
  </script>

  <script>
 document.addEventListener('DOMContentLoaded', function() {
    const ts = new TomSelect('#currencySelect', {
      maxItems: 1,
      closeAfterSelect: true,
      dropdownParent: 'body',
      rtl: true //changes to right to left
    });
    ts.on('change', handleCurrencyChange);
    // Blur on add item
    ts.on('item_add', () => {
      ts.blur();
    });

    // Blur on enter/return
    document.getElementById("mithqals").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.target.blur();
      }
    });

    // Blur on enter/return
    document.getElementById("money").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.target.blur();
      }
    });
  });
    

    function handleCurrencyChange() {
      const currency = document.getElementById("currencySelect").value;
      if (currency === "CUSTOM") {
        document.getElementById("customRateContainer").style.display = "block";
      } else {
        document.getElementById("customRateContainer").style.display = "none";
      }
      calculateMoneyFromMithqals();
    }

    //remove invalid chars and it allow one decimal and adds the commas
    function formatMoney(input) {
      let value = input.value.replace(/[^0-9.]/g, ""); //Removes invalid inputs
      const parts = value.split(".");
      if (parts.length > 2) {
        value = parts[0] + "." + parts[1]; //keeping one decimal
      }
      const integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      input.value = parts.length > 1 ? integerPart + "." + parts[1] : integerPart;
    }

    // For mithqals, we do the same formatting
    function formatMithqals(input) {
      formatMoney(input);
    }

    // If user changes custom rate
    function customRateChanged() {
      if (document.getElementById("currencySelect").value === "CUSTOM") {
        calculateMoneyFromMithqals();
      }
    }

    //  mithqals -> currency
    async function calculateMoneyFromMithqals() {
      const mithqals = parseFloat(document.getElementById("mithqals").value.replace(/,/g, ""));
      const metalType = document.querySelector('input[name="metalType"]:checked').value;
      const currency = document.getElementById("currencySelect").value;

      if (isNaN(mithqals) || mithqals <= 0) {
        document.getElementById("money").value = "";
        return;
      }

      const metalPrice = await fetchMetalPrice(metalType);
      const usdPricePerMithqal = metalPrice * 3.641667; // gold/silver price * mithqal in grams
      let valueInUSD = mithqals * usdPricePerMithqal;

      if (currency !== "USD") {
        const exchangeRate = await fetchCurrencyRate(currency);
        valueInUSD *= exchangeRate;
      }

      // Format final currency output
      document.getElementById("money").value = valueInUSD.toLocaleString("en-US", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    }

    //  currency -> mithqals
    async function calculateMithqalsFromMoney() {
      const money = parseFloat(document.getElementById("money").value.replace(/,/g, ""));
      const metalType = document.querySelector('input[name="metalType"]:checked').value;
      const currency = document.getElementById("currencySelect").value;

      if (isNaN(money) || money <= 0) {
        document.getElementById("mithqals").value = "";
        return;
      }

      const metalPrice = await fetchMetalPrice(metalType);
      const usdPricePerMithqal = metalPrice * 3.641667;
      let moneyInUSD = money;

      if (currency !== "USD") {
        const exchangeRate = await fetchCurrencyRate(currency);
        moneyInUSD /= exchangeRate;
      }

      const mithqals = moneyInUSD / usdPricePerMithqal;
      document.getElementById("mithqals").value = mithqals.toLocaleString("en-US", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    }

    // Get gold or silver price from gold-api.com
    async function fetchMetalPrice(metalType) {
      const url = 
        (metalType === "gold") 
          ? "https://api.gold-api.com/price/XAU" 
          : "https://api.gold-api.com/price/XAG";
      try {
        const response = await fetch(url);
        const data = await response.json();
        // price given in USD per oz then convert to grams for the gold
        return data.price / 31.1035; 
      } catch (error) {
        console.error(`Unable to fetch ${metalType} price`, error);
        return 0;
      }
    }
    //check if custom if NOT custom then fetch API
    async function fetchCurrencyRate(currency) {
      if (currency === "CUSTOM") {
        const customRateValue = parseFloat(
          document.getElementById("customRate").value.replace(/,/g, "")
        ) || 1;
        return customRateValue; 
      }
      const url = `https://hexarate.paikama.co/api/rates/latest/USD?target=${currency}`;
      try {
        const response = await fetch(url);
        const data = await response.json();
        return data.data.mid; 
      } catch (error) {
        console.error(`Unable to fetch rate for ${currency}`, error);
        return 1; 
      }
    }

    // Listen for users input
    document.getElementById("mithqals").addEventListener("input", calculateMoneyFromMithqals);
    document.getElementById("money").addEventListener("input", calculateMithqalsFromMoney);
    document.querySelectorAll('input[name="metalType"]').forEach((radio) => {
      radio.addEventListener("change", () => {
        calculateMoneyFromMithqals();
      });
    });
  </script>
</body>
</html>
