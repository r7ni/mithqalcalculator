<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" 
  content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <!-- i hope you have a great day! -->
  <title>ماشین حساب مثقال و ارزهای نقدی</title>
  <meta name="description" content="ماشین حساب دوطرفه - تبدیل بین مثقال بهائی و ارزهای نقدی">  
  
  <link rel="stylesheet" href="fa.css">
  <link 
    rel="stylesheet" 
    href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css"
  />
  <link rel="apple-touch-icon-precomposed" sizes="57x57" href="favicon/apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="favicon/apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="favicon/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="favicon/apple-touch-icon-144x144.png" />
  <link rel="apple-touch-icon-precomposed" sizes="60x60" href="favicon/apple-touch-icon-60x60.png" />
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="favicon/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon-precomposed" sizes="76x76" href="favicon/apple-touch-icon-76x76.png" />
  <link rel="apple-touch-icon-precomposed" sizes="152x152" href="favicon/apple-touch-icon-152x152.png" />
  <link rel="icon" type="image/png" href="favicon/favicon-196x196.png" sizes="196x196" />
  <link rel="icon" type="image/png" href="favicon/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/png" href="favicon/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="favicon/favicon-16x16.png" sizes="16x16" />
  <link rel="icon" type="image/png" href="favicon/favicon-128.png" sizes="128x128" />
  <meta name="application-name" content="&nbsp;"/>
  <meta name="msapplication-TileColor" content="#FFFFFF" />
  <meta name="msapplication-TileImage" content="favicon/mstile-144x144.png" />
  <meta name="msapplication-square70x70logo" content="favicon/mstile-70x70.png" />
  <meta name="msapplication-square150x150logo" content="favicon/mstile-150x150.png" />
  <meta name="msapplication-wide310x150logo" content="favicon/mstile-310x150.png" />
  <meta name="msapplication-square310x310logo" content="favicon/mstile-310x310.png" />
  
</head>

<body>
  <div class="background"></div>
  <div class="calculator">
    <p class="a">الله أبهی</p>
    <div class="h1title">
    <h1 class="left">
      ارز 
    </h1>
        <p class="pt">⇄</p>  
        <h1 class="right" >
            مثقال
    </h1>
    </div>
    <p class="b">
      ماشین‌ حساب دوطرفه      
    </p> 
    <div class="form-group">
      <label class="c" for="metalType">:فـلـز</label>
      <div class="radio-inputs">
        <label class="radio">
          <input type="radio" name="metalType" value="gold" checked>
          <span class="name">طـلا</span>
        </label>
        <label class="radio">
          <input type="radio" name="metalType" value="silver">
          <span class="name">نقـره</span>
        </label>
      </div>
    </div>
    <div class="form-group">
      <label for="mithqals">:وزن در مثقـال</label>
      <input 
        type="text" 
        id="mithqals" 
        placeholder="مقدار مثقال را وارد کنید"
        oninput="formatMithqals(this); calculateMoneyFromMithqals()"
      />
    </div>
    <div class="form-group">
      <label for="money">:مقـدار ارز</label>
      <input 
        type="text" 
        id="money" 
        placeholder="مقدار ارز را وارد کنید"
        oninput="formatMoney(this); calculateMithqalsFromMoney()"
        />
    </div>
    <div class="form-group">
        <label for="currencySelect">:ارز</label>
        <select id="currencySelect" placeholder="Select or type to search">
          <option value="USD">USD – دلار آمریکایی</option>
          <option value="EUR">EUR – یورو</option>
          <option value="GBP">GBP – پوند استرلینگ</option>
          <option value="CAD">CAD – دلار کانادایی</option>
          <option value="CUSTOM">CUSTOM – نرخ تبدیل خود را تنظیم کنید</option>
          <option value="IRR">IRR – ریال ایران</option>
          <option value="AFN">AFN – افغانی افغانستان</option>
          <option value="AZN">AZN – منات آذربایجان</option>
          <option value="TRY">TRY – لیره ترکیه</option>
          <option disabled="true" value="none">.---- ----.  .---- ----.  .---- ----.  .---- ----.  .---- ----.</option>
          
          <option value="ARS">ARS – پزو آرژانتین</option>
          <option value="AUD">AUD – دلار استرالیا</option>
          <option value="BHD">BHD – دینار بحرین</option>
          <option value="BDT">BDT – تاکا بنگلادش</option>
          <option value="BOL">BOL – بولیویانو بولیوی</option>
          <option value="BRL">BRL – رئال برزیل</option>
          <option value="CDF">CDF – فرانک کنگو</option>
          <option value="CLP">CLP – پزو شیلی</option>
          <option value="CNY">CNY – یوان چین</option>
          <option value="COP">COP – پزو کلمبیا</option>
          <option value="CZK">CZK – کرون چک</option>
          <option value="DKK">DKK – کرون دانمارک</option>
          <option value="DZD">DZD – دینار الجزایر</option>
          <option value="EGP">EGP – پوند مصر</option>
          <option value="ETB">ETB – بیر اتیوپی</option>
          <option value="FJD">FJD – دلار فیجی</option>
          <option value="GEL">GEL – لاری گرجستان</option>
          <option value="HKD">HKD – دلار هنگ‌کنگ</option>
          <option value="HUF">HUF – فورینت مجارستان</option>
          <option value="IDR">IDR – روپیه اندونزی</option>
          <option value="ILS">ILS – شِکِل جدید اسرائیل</option>
          <option value="IQD">IQD – دینار عراق</option>
          <option value="ISK">ISK – کرون ایسلند</option>
          <option value="JOD">JOD – دینار اردن</option>
          <option value="JPY">JPY – ین ژاپن</option>
          <option value="KES">KES – شیلینگ کنیا</option>
          <option value="KWD">KWD – دینار کویت</option>
          <option value="MAD">MAD – درهم مراکش</option>
          <option value="MXN">MXN – پزو مکزیک</option>
          <option value="MYR">MYR – رینگیت مالزی</option>
          <option value="NAD">NAD – دلار نامیبیا</option>
          <option value="NGN">NGN – نایرا نیجریه</option>
          <option value="NOK">NOK – کرون نروژ</option>
          <option value="NPR">NPR – روپیه نپال</option>
          <option value="NZD">NZD – دلار نیوزیلند</option>
          <option value="OMR">OMR – ریال عمان</option>
          <option value="PGK">PGK – کینا پاپوآ گینه نو</option>
          <option value="PHP">PHP – پزو فیلیپین</option>
          <option value="PKR">PKR – روپیه پاکستان</option>
          <option value="PLN">PLN – زلوتی لهستان</option>
          <option value="QAR">QAR – ریال قطر</option>
          <option value="RUB">RUB – روبل روسیه</option>
          <option value="SAR">SAR – ریال سعودی</option>
          <option value="SGD">SGD – دلار سنگاپور</option>
          <option value="THB">THB – بات تایلند</option>
          <option value="TMT">TMT – منات ترکمنستان</option>
          <option value="TND">TND – دینار تونس</option>
          <option value="TRY">TRY – لیره ترکیه</option>
          <option value="TZS">TZS – شیلینگ تانزانیا</option>
          <option value="UAH">UAH – هریونا اوکراین</option>
          <option value="UGX">UGX – شیلینگ اوگاندا</option>
          <option value="UZS">UZS – سوم ازبکستان</option>
          <option value="VND">VND – دانگ ویتنام</option>
          <option value="VUV">VUV – واتو وانواتو</option>
          <option value="ZAR">ZAR – رند آفریقای جنوبی</option>
          <option value="ZMW">ZMW – کواچا زامبیا</option>
      </select>
    </div>

    <!-- The custom rate container def=hidden -->
    <div class="form-group" id="customRateContainer">
      <label for="customRate">یک دلار = ؟</label>
      <input 
        type="text" 
        id="customRate" 
        placeholder="نرخ ارز خود را وارد کنید"
        oninput="formatMoney(this); customRateChanged();"
      />
    </div>


    <div class="bottombox">

      <a href="index.html" class="aboutlink"><i>english</i></a>
      <a href="fa-about.html" class="noteng"><i>اطلاعات بیشتر</i></a>
      <a href="ar.html" class="noteng"><i>عربي</i></a>
      
    </div>

  </div>

  <script 
    src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js">
  </script>

  <script>
 document.addEventListener('DOMContentLoaded', function() {
    const ts = new TomSelect('#currencySelect', {
      maxItems: 1,
      closeAfterSelect: true,
      dropdownParent: 'body',
      rtl: true //changes to right to left
    });
    ts.on('change', handleCurrencyChange);
    // Blur on add item
    ts.on('item_add', () => {
      ts.blur();
    });

    // Blur on enter/return
    document.getElementById("mithqals").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.target.blur();
      }
    });

    // Blur on enter/return
    document.getElementById("money").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.target.blur();
      }
    });
  });
    

    function handleCurrencyChange() {
      const currency = document.getElementById("currencySelect").value;
      if (currency === "CUSTOM") {
        document.getElementById("customRateContainer").style.display = "block";
      } else {
        document.getElementById("customRateContainer").style.display = "none";
      }
      calculateMoneyFromMithqals();
    }

    //remove invalid chars and it allow one decimal and adds the commas
    function formatMoney(input) {
      let value = input.value.replace(/[^0-9.]/g, ""); //Removes invalid inputs
      const parts = value.split(".");
      if (parts.length > 2) {
        value = parts[0] + "." + parts[1]; //keeping one decimal
      }
      const integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      input.value = parts.length > 1 ? integerPart + "." + parts[1] : integerPart;
    }

    // For mithqals, we do the same formatting
    function formatMithqals(input) {
      formatMoney(input);
    }

    // If user changes custom rate
    function customRateChanged() {
      if (document.getElementById("currencySelect").value === "CUSTOM") {
        calculateMoneyFromMithqals();
      }
    }

    //  mithqals -> currency
    async function calculateMoneyFromMithqals() {
      const mithqals = parseFloat(document.getElementById("mithqals").value.replace(/,/g, ""));
      const metalType = document.querySelector('input[name="metalType"]:checked').value;
      const currency = document.getElementById("currencySelect").value;

      if (isNaN(mithqals) || mithqals <= 0) {
        document.getElementById("money").value = "";
        return;
      }

      const metalPrice = await fetchMetalPrice(metalType);
      const usdPricePerMithqal = metalPrice * 3.641667; // gold/silver price * mithqal in grams
      let valueInUSD = mithqals * usdPricePerMithqal;

      if (currency !== "USD") {
        const exchangeRate = await fetchCurrencyRate(currency);
        valueInUSD *= exchangeRate;
      }

      // Format final currency output
      document.getElementById("money").value = valueInUSD.toLocaleString("en-US", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    }

    //  currency -> mithqals
    async function calculateMithqalsFromMoney() {
      const money = parseFloat(document.getElementById("money").value.replace(/,/g, ""));
      const metalType = document.querySelector('input[name="metalType"]:checked').value;
      const currency = document.getElementById("currencySelect").value;

      if (isNaN(money) || money <= 0) {
        document.getElementById("mithqals").value = "";
        return;
      }

      const metalPrice = await fetchMetalPrice(metalType);
      const usdPricePerMithqal = metalPrice * 3.641667;
      let moneyInUSD = money;

      if (currency !== "USD") {
        const exchangeRate = await fetchCurrencyRate(currency);
        moneyInUSD /= exchangeRate;
      }

      const mithqals = moneyInUSD / usdPricePerMithqal;
      document.getElementById("mithqals").value = mithqals.toLocaleString("en-US", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    }

    // Get gold or silver price from gold-api.com
    async function fetchMetalPrice(metalType) {
      const url = 
        (metalType === "gold") 
          ? "https://api.gold-api.com/price/XAU" 
          : "https://api.gold-api.com/price/XAG";
      try {
        const response = await fetch(url);
        const data = await response.json();
        // price given in USD per oz then convert to grams for the gold
        return data.price / 31.1035; 
      } catch (error) {
        console.error(`Unable to fetch ${metalType} price`, error);
        return 0;
      }
    }
    //check if custom if NOT custom then fetch API
    async function fetchCurrencyRate(currency) {
      if (currency === "CUSTOM") {
        const customRateValue = parseFloat(
          document.getElementById("customRate").value.replace(/,/g, "")
        ) || 1;
        return customRateValue; 
      }
      const url = `https://hexarate.paikama.co/api/rates/latest/USD?target=${currency}`;
      try {
        const response = await fetch(url);
        const data = await response.json();
        return data.data.mid; 
      } catch (error) {
        console.error(`Unable to fetch rate for ${currency}`, error);
        return 1; 
      }
    }

    // Listen for users input
    document.getElementById("mithqals").addEventListener("input", calculateMoneyFromMithqals);
    document.getElementById("money").addEventListener("input", calculateMithqalsFromMoney);
    document.querySelectorAll('input[name="metalType"]').forEach((radio) => {
      radio.addEventListener("change", () => {
        calculateMoneyFromMithqals();
      });
    });
  </script>
</body>
</html>
