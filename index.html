<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" 
  content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <!-- i hope you have a great day! -->
  <title>mithqál currency calculator</title>
  <link rel="icon" type="image/png" href="favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="favicon-16x16.png" sizes="16x16" />
  <meta name="description" content="A two-way calculator to convert between Bahá'í mithqáls and world currencies.">
  
  <link rel="stylesheet" href="styles.css">
  <link 
    rel="stylesheet" 
    href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css"
  />
  <link rel="apple-touch-icon-precomposed" sizes="57x57" href="favicon/apple-touch-icon-57x57.png" />
  <link rel="apple-touch-icon-precomposed" sizes="114x114" href="favicon/apple-touch-icon-114x114.png" />
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="favicon/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="favicon/apple-touch-icon-144x144.png" />
  <link rel="apple-touch-icon-precomposed" sizes="60x60" href="favicon/apple-touch-icon-60x60.png" />
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="favicon/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon-precomposed" sizes="76x76" href="favicon/apple-touch-icon-76x76.png" />
  <link rel="apple-touch-icon-precomposed" sizes="152x152" href="favicon/apple-touch-icon-152x152.png" />
  <link rel="icon" type="image/png" href="favicon/favicon-196x196.png" sizes="196x196" />
  <link rel="icon" type="image/png" href="favicon/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/png" href="favicon/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="favicon/favicon-16x16.png" sizes="16x16" />
  <link rel="icon" type="image/png" href="favicon/favicon-128.png" sizes="128x128" />
  <meta name="application-name" content="&nbsp;"/>
  <meta name="msapplication-TileColor" content="#FFFFFF" />
  <meta name="msapplication-TileImage" content="favicon/mstile-144x144.png" />
  <meta name="msapplication-square70x70logo" content="favicon/mstile-70x70.png" />
  <meta name="msapplication-square150x150logo" content="favicon/mstile-150x150.png" />
  <meta name="msapplication-wide310x150logo" content="favicon/mstile-310x150.png" />
  <meta name="msapplication-square310x310logo" content="favicon/mstile-310x310.png" />
  
</head>

<body>
  <div class="background"></div>
  <div class="calculator">
    <p class="a">Alláh'u'Abhá</p>
    <h2 class="h2">mithqál ⇄ currency</h2>
    <p class="b">two-way calculator</p>
    <div class="form-group">
      <label class="c" for="metalType">metal:</label>
      <div class="radio-inputs">
        <label class="radio">
          <input type="radio" name="metalType" value="gold" checked>
          <span class="name">Gold</span>
        </label>
        <label class="radio">
          <input type="radio" name="metalType" value="silver">
          <span class="name">Silver</span>
        </label>
      </div>
    </div>
    <div class="form-group">
      <label for="mithqals"><i># in mithqáls:</i></label>
      <input 
        type="text" 
        id="mithqals" 
        placeholder="enter the amount of mithqáls" 
        oninput="formatMithqals(this); calculateMoneyFromMithqals()"
      />
    </div>
    <div class="form-group">
      <label for="money"><i># in currency:</i></label>
      <input 
        type="text" 
        id="money" 
        placeholder="enter the amount of currency" 
        oninput="formatMoney(this); calculateMithqalsFromMoney()"
      />
    </div>
    <div class="form-group">
      <label for="currencySelect"><i>currency:</i></label>
      <select id="currencySelect" placeholder="Select or type to search">
        <option value="USD">USD – United States Dollar</option>
        <option value="EUR">EUR – Euro</option>
        <option value="GBP">GBP – British Pound</option>
        <option value="CAD">CAD – Canadian Dollar</option>
        <option value="CUSTOM">CUSTOM – Set your own rate</option>
        <option disabled="true" value="none">.---- ----.  .---- ----.  .---- ----.  .---- ----.  .---- ----.</option>
        <option value="ARS">ARS – Argentine Peso</option>
        <option value="AUD">AUD – Australian Dollar</option>
        <option value="BHD">BHD – Bahraini Dinar</option>
        <option value="BRL">BRL – Brazilian Real</option>
        <option value="CNY">CNY – Chinese Yuan</option>
        <option value="COP">COP – Colombian Peso</option>
        <option value="DKK">DKK – Danish Krone</option>
        <option value="EGP">EGP – Egyptian Pound</option>
        <option value="HKD">HKD – Hong Kong Dollar</option>
        <option value="INR">INR – Indian Rupee</option>
        <option value="IDR">IDR – Indonesian Rupiah</option>
        <option value="ILS">ILS – Israeli New Shekel</option>
        <option value="JPY">JPY – Japanese Yen</option>
        <option value="JOR">JOR – Jordanian Dinar</option>
        <option value="KWD">KWD – Kuwaiti Dinar</option>
        <option value="MYR">MYR – Malaysian Ringgit</option>
        <option value="MXN">MXN – Mexican Peso</option>
        <option value="NZD">NZD – New Zealand Dollar</option>
        <option value="NGN">NGN – Nigerian Naira</option>
        <option value="NOK">NOK – Norwegian Krone</option>
        <option value="PKR">PKR – Pakistani Rupee</option>
        <option value="PHP">PHP – Philippine Peso</option>
        <option value="PLN">PLN – Polish Zloty</option>
        <option value="RUB">RUB – Russian Ruble</option>
        <option value="SAR">SAR – Saudi Riyal</option>
        <option value="SGD">SGD – Singapore Dollar</option>
        <option value="ZAR">ZAR – South African Rand</option>
        <option value="KRW">KRW – South Korean Won</option>
        <option value="SEK">SEK – Swedish Krona</option>
        <option value="CHF">CHF – Swiss Franc</option>
        <option value="THB">THB – Thai Baht</option>
        <option value="TRY">TRY – Turkish Lira</option>
        <option value="AED">AED – United Arab Emirates Dirham</option>
        <option value="VND">VND – Vietnamese Dong</option>
      </select>
    </div>

    <!-- The custom rate container def=hidden -->
    <div class="form-group" id="customRateContainer">
      <label for="customRate"><i>1 usd = ?</i></label>
      <input 
        type="text" 
        id="customRate" 
        placeholder="enter your custom rate"
        oninput="formatMoney(this); customRateChanged();"
      />
    </div>

    <p class="d">mithqál = 3.641667 g</p>


      <a href="about.html" class="aboutlink">about</a>
  </div>

  <script 
    src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js">
  </script>

  <script>
 document.addEventListener('DOMContentLoaded', function() {
    const ts = new TomSelect('#currencySelect', {
      maxItems: 1,
      closeAfterSelect: true,
      dropdownParent: 'body'
    });
    ts.on('change', handleCurrencyChange);
    // Blur on add item
    ts.on('item_add', () => {
      ts.blur();
    });

    // Blur on enter/return
    document.getElementById("mithqals").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.target.blur();
      }
    });

    // Blur on enter/return
    document.getElementById("money").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.target.blur();
      }
    });
  });
    

    function handleCurrencyChange() {
      const currency = document.getElementById("currencySelect").value;
      if (currency === "CUSTOM") {
        document.getElementById("customRateContainer").style.display = "block";
      } else {
        document.getElementById("customRateContainer").style.display = "none";
      }
      calculateMoneyFromMithqals();
    }

    //remove invalid chars and it allow one decimal and adds the commas
    function formatMoney(input) {
      let value = input.value.replace(/[^0-9.]/g, ""); //Removes invalid inputs
      const parts = value.split(".");
      if (parts.length > 2) {
        value = parts[0] + "." + parts[1]; //keeping one decimal
      }
      const integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      input.value = parts.length > 1 ? integerPart + "." + parts[1] : integerPart;
    }

    // For mithqals, we do the same formatting
    function formatMithqals(input) {
      formatMoney(input);
    }

    // If user changes custom rate
    function customRateChanged() {
      if (document.getElementById("currencySelect").value === "CUSTOM") {
        calculateMoneyFromMithqals();
      }
    }

    //  mithqals -> currency
    async function calculateMoneyFromMithqals() {
      const mithqals = parseFloat(document.getElementById("mithqals").value.replace(/,/g, ""));
      const metalType = document.querySelector('input[name="metalType"]:checked').value;
      const currency = document.getElementById("currencySelect").value;

      if (isNaN(mithqals) || mithqals <= 0) {
        document.getElementById("money").value = "";
        return;
      }

      const metalPrice = await fetchMetalPrice(metalType);
      const usdPricePerMithqal = metalPrice * 3.641667; // gold/silver price * mithqal in grams
      let valueInUSD = mithqals * usdPricePerMithqal;

      if (currency !== "USD") {
        const exchangeRate = await fetchCurrencyRate(currency);
        valueInUSD *= exchangeRate;
      }

      // Format final currency output
      document.getElementById("money").value = valueInUSD.toLocaleString("en-US", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    }

    //  currency -> mithqals
    async function calculateMithqalsFromMoney() {
      const money = parseFloat(document.getElementById("money").value.replace(/,/g, ""));
      const metalType = document.querySelector('input[name="metalType"]:checked').value;
      const currency = document.getElementById("currencySelect").value;

      if (isNaN(money) || money <= 0) {
        document.getElementById("mithqals").value = "";
        return;
      }

      const metalPrice = await fetchMetalPrice(metalType);
      const usdPricePerMithqal = metalPrice * 3.641667;
      let moneyInUSD = money;

      if (currency !== "USD") {
        const exchangeRate = await fetchCurrencyRate(currency);
        moneyInUSD /= exchangeRate;
      }

      const mithqals = moneyInUSD / usdPricePerMithqal;
      document.getElementById("mithqals").value = mithqals.toLocaleString("en-US", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    }

    // Get gold or silver price from gold-api.com
    async function fetchMetalPrice(metalType) {
      const url = 
        (metalType === "gold") 
          ? "https://api.gold-api.com/price/XAU" 
          : "https://api.gold-api.com/price/XAG";
      try {
        const response = await fetch(url);
        const data = await response.json();
        // price given in USD per oz then convert to grams for the gold
        return data.price / 31.1035; 
      } catch (error) {
        console.error(`Unable to fetch ${metalType} price`, error);
        return 0;
      }
    }
    //check if custom if NOT custom then fetch API
    async function fetchCurrencyRate(currency) {
      if (currency === "CUSTOM") {
        const customRateValue = parseFloat(
          document.getElementById("customRate").value.replace(/,/g, "")
        ) || 1;
        return customRateValue; 
      }
      const url = `https://hexarate.paikama.co/api/rates/latest/USD?target=${currency}`;
      try {
        const response = await fetch(url);
        const data = await response.json();
        return data.data.mid; 
      } catch (error) {
        console.error(`Unable to fetch rate for ${currency}`, error);
        return 1; 
      }
    }

    // Listen for users input
    document.getElementById("mithqals").addEventListener("input", calculateMoneyFromMithqals);
    document.getElementById("money").addEventListener("input", calculateMithqalsFromMoney);
    document.querySelectorAll('input[name="metalType"]').forEach((radio) => {
      radio.addEventListener("change", () => {
        calculateMoneyFromMithqals();
      });
    });
  </script>
</body>
</html>
